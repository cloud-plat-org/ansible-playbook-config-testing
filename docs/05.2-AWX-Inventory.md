
# AWX Inventory Management

This guide covers how to interact with AWX Configuration - Inventory, Groups, Projects & Templates

## ðŸ“‹ **WSL Lab Host Configuration**

### **Host List**
```bash
# Define all WSL Lab hosts with their connection details
declare -A WSL_HOSTS=(
    ["argo_cd_mgt"]="172.22.192.129:2226:daniv"
    ["ubuntuAWX"]="172.22.192.129:2225:daniv"
    ["wslkali1"]="172.22.192.129:2224:daniv"
    ["wslubuntu1"]="172.22.192.129:2223:daniv"
)

# Define groups for organization
declare -A HOST_GROUPS=(
    ["all_servers"]="argo_cd_mgt ubuntuAWX wslkali1 wslubuntu1"
    ["management"]="ubuntuAWX"
    ["test_servers"]="wslkali1 wslubuntu1"
)
```

## Prerequisites

Set up your AWX environment variables:
```bash
# Activate AWX virtual environment
source ~/awx-venv/bin/activate
# Extract stored OAuth2 token
export AWX_TOKEN=$(kubectl get secret awx-admin-password -n awx -o jsonpath='{.data.password}' | base64 -d)
export INVENTORY_NAME="WSL Lab"
export GROUP_NAME="all_servers"

# Create inventory
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory create \
  --name "$INVENTORY_NAME" \
  --description "WSL instances for automation" \
  --organization Default

# Get the inventory ID
INVENTORY_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory list --name "$INVENTORY_NAME" --format json | jq -r '.results[0].id')

echo "Inventory ID: $INVENTORY_ID"
```

## 2. Addd host to new inventory
```bash
# Add argo_cd_mgt host
HOST_NAME="argo_cd_mgt"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2226, "ansible_user": "daniv", "ansible_ssh_private_key_file": "~/.ssh/id_rsa"} | jq '{id, name, status, variables}'

# Delete host by name
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" hosts delete "$HOST_NAME"
# Delete host by name (this removes it from ALL inventories)

# List all hosts with the name "argo_cd_mgt" to get their IDs
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --name "argo_cd_mgt" | jq '.results[] | {id: .id, name: .name, inventory: .summary_fields.inventories[0].name}'

# Add argo_cd_mgt host
HOST_NAME="argo_cd_mgt"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2226, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add ubuntuAWX host
HOST_NAME="ubuntuAWX"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2225, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add wslkali1 host
HOST_NAME="wslkali1"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2224, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add wslubuntu1 host
HOST_NAME="wslubuntu1"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2223, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'


# Check if the host was added successfully
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --inventory "$INVENTORY_ID" | jq '.results[] | {name, variables}'
```

## NEXT GROUP INVENTORY
<!--
Inventory "WSL Lab"
â”œâ”€â”€ Host "ubuntuAWX" (has IP, port, user, SSH key, etc.)
â”œâ”€â”€ Host "wslkali1" (has IP, port, user, SSH key, etc.)
â””â”€â”€ Groups:
    â”œâ”€â”€ "all_servers" â†’ references existing hosts by name
    â””â”€â”€ "web_servers" â†’ references existing hosts by name -->

```bash

# Create host group
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" group create \
  --name "$GROUP_NAME" \
  --inventory "$INVENTORY_NAME"

# Show group name, inventory ID, and inventory name
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list | jq '.results[] | {name: .name, inventory_id: .inventory, inventory_name: .summary_fields.inventory.name}'

# Add host to group (replace with actual names)
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups associate_host \
  --group "all_servers" \
  --host "ubuntuAWX"

```














# Create host group
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" group create \
  --name all_servers \
  --inventory "WSL Lab"

# Show group name, inventory ID, and inventory name
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list | jq '.results[] | {name: .name, inventory_id: .inventory, inventory_name: .summary_fields.inventory.name}'

# Add host to group (replace with actual names)
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups associate_host \
  --group "all_servers" \
  --host "ubuntuAWX"


# First get the group ID
GROUP_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list --name "all_servers" | jq -r '.results[0].id')
echo "$GROUP_ID"

# Then add host to group by ID
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups associate_host \
  --group "$GROUP_ID" \
  --host "ubuntuAWX"














## 1. Get Inventory Information

### Get Inventory ID
```bash
# Get the inventory ID for the "WSL Lab" inventory
INVENTORY_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory list --name "$INVENTORY_NAME" --format json | jq -r '.results[0].id')

echo "Inventory ID: $INVENTORY_ID"
```

## 2. Addd host to new inventory
```bash
# Add argo_cd_mgt host
HOST_NAME="argo_cd_mgt"
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "$HOST_NAME" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2226, "ansible_user": "daniv", "ansible_ssh_private_key_file": "~/.ssh/id_rsa"} | jq '{id, name, status, variables}'

  # Delete host by name
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" hosts delete "$HOST_NAME"
# Delete host by name (this removes it from ALL inventories)

# List all hosts with the name "argo_cd_mgt" to get their IDs
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --name "argo_cd_mgt" | jq '.results[] | {id: .id, name: .name, inventory: .summary_fields.inventories[0].name}'

# Add argo_cd_mgt host
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "argo_cd_mgt" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2226, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add ubuntuAWX host
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "ubuntuAWX" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2225, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add wslkali1 host
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "wslkali1" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2224, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'

# Add wslubuntu1 host
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
  --name "wslubuntu1" \
  --inventory "$INVENTORY_ID" \
  --variables '{"ansible_host": "172.22.192.129", "ansible_port": 2223, "ansible_user": "daniv", "ansible_ssh_private_key_file": "/home/daniv/.ssh/id_rsa"}'


# Check if the host was added successfully
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --inventory "$INVENTORY_ID" | jq '.results[] | {name, variables}'

```

## 2. List Hosts in Inventory

### Quick Host Summary
```bash
# Get basic host information
host_json=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$INVENTORY_NAME" --format json)

echo "=== Host Summary for '$INVENTORY_NAME' ==="
echo "$host_json" | jq -r '.results[] | "Host: \(.name), Last Job: \(.last_job), Variables: \(.variables)"'
```

### Detailed Host Information
```bash
# Get detailed host information with variables
echo "$host_json" | jq -r '.results[] | 
  "Host: " + .name + "\n" +
  "  Last Job: " + (.last_job | tostring) + "\n" +
  "  Variables: " + (.variables | tostring) + "\n"'
```

### Current WSL Lab Hosts
Based on your AWX inventory, you have these hosts:
- **argo_cd_mgt**: `172.22.192.129:2226`
- **ubuntuAWX**: `172.22.192.129:2225`
- **wslkali1**: `172.22.192.129:2224`
- **wslubuntu1**: `172.22.192.129:2223`

## 3. Export Inventory to YAML

### Simple Export (Basic Format)
```bash
# Export hosts to basic YAML format
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$INVENTORY_NAME" --format json | \
jq -r '.results[] | "- name: \(.name)\n  ansible_host: \(.variables | fromjson | .ansible_host)\n  ansible_port: \(.variables | fromjson | .ansible_port)\n  ansible_user: daniv"' > inventory/wsl_instances_actual.yml
```



```bash
PROJECT_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project list | jq -r '.results[] | select(.name=="WSL Project") | .id')
echo "Project ID: $PROJECT_ID"



# Get project ID by name
PROJECT_NAME="WSL Project"
PROJECT_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects list --name "$PROJECT_NAME" | jq -r '.results[0].id')

echo "Project ID: $PROJECT_ID"
# DELETE the existing project
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects delete "$PROJECT_ID"

# Create project with auto-update enabled and extract PROJECT_ID
PROJECT_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false projects create \
  --name "$PROJECT_NAME" \
  --description "Playbooks for WSL Lab" \
  --organization "Default" \
  --scm_type "git" \
  --scm_update_on_launch true \
  --scm_url "https://github.com/cloud-plat-org/ansible-playbook-config-testing.git" \
  --scm_branch "CLPLAT-2230" | jq -r '.id')

echo "Project ID: $PROJECT_ID"

PROJECT_ID=32
echo "$PROJECT_ID"




# Check the sync status
PROJECT_UPDATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates list --project "$PROJECT_ID" | jq -r '.results[0].id')
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates get "$PROJECT_UPDATE_ID" | jq '{id, status}'
echo $PROJECT_UPDATE_ID
```




##  **Updated AWX Job Template Creation Commands**

### **Step 1: Set up your AWX token**
```bash
export AWX_TOKEN=$(kubectl get secret awx-admin-password -n awx -o jsonpath='{.data.password}' | base64 -d)
```

### **Step 2: Get your existing project ID**
```bash
### ABOVE

### **Step 3: Create the Job Template using your existing project**
```bash
TEMPLATE_NAME="Test Service Lifecycle WSL"
TEMPLATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false job_templates list --name "$TEMPLATE_NAME" | jq -r '.results[0].id')

echo "Template ID: $TEMPLATE_ID"
# DELETE the existing job template
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates delete "$TEMPLATE_ID"



# Create the job template using your existing WSL Project
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates create \
  --name "Auto Service Management" \
  --job_type "run" \
  --inventory "WSL Lab" \
  --project "WSL Project" \
  --playbook "playbooks/service_management.yml" \
  --become_enabled "true" \
  --extra_vars '{"service_name": "cron", "service_state": "stopped", "debug_extra": false}'

```

### **Step 4: Verify the job template was created**
```bash
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates list --name "Service Management - WSL Instances"
```

### **Step 5: (Optional) Create a Survey for better user experience**
```bash
# Get the job template ID first
JOB_TEMPLATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates list --name "Service Management - WSL Instances" | jq -r '.results[0].id')

# # Add survey
# awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates survey_spec \
#   --id "$JOB_TEMPLATE_ID" \
#   --spec '{
#     "name": "Service Management Survey",
#     "description": "Configure service management parameters",
#     "spec": [
#       {
#         "type": "text",
#         "question_name": "Service Name",
#         "variable": "service_name",
#         "default": "cron",
#         "question_description": "Name of the service to manage (e.g., cron, sshd, nginx)"
#       },
#       {
#         "type": "multiplechoice",
#         "question_name": "Service State",
#         "variable": "service_state",
#         "choices": ["started", "stopped", "restarted", "reloaded"],
#         "default": "started",
#         "question_description": "Desired state of the service"
#       },
#       {
#         "type": "multiplechoice",
#         "question_name": "Debug Output",
#         "variable": "debug_extra",
#         "choices": ["false", "true"],
#         "default": "false",
#         "question_description": "Show verbose debug output (false = clean, true = verbose)"
#       }
#     ]
#   }'
# ```

## ðŸ“‹ **Key Changes Made:**

- **Used existing project**: "WSL Project" instead of creating a new one
- **Repository**: Points to your existing `https://github.com/cloud-plat-org/ansible-playbook-config-testing.git`
- **Branch**: Will use your configured branch `CLPLAT-2225`
- **Auto-update**: Your project has `scm_update_on_launch: true`, so it will pull latest changes















The issue is that you need to update the project configuration first, then sync. Try this approach:

### **Step 1: Update the project configuration directly**
```bash
# Update the project to use CLPLAT-2230 branch
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" \
  --scm_branch "CLPLAT-2230" \
  --scm_update_on_launch true
```

### **Step 2: Wait for the update to complete, then check status**
```bash
# Wait a moment, then check the latest project update
PROJECT_UPDATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates list --project "$PROJECT_ID" | jq -r '.results[0].id')
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates get "$PROJECT_UPDATE_ID" | jq '{id, status, scm_branch}'
```

### **Step 3: Once the update shows "successful" status, try creating the job template**
```bash
# Create the job template
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates create \
  --name "Auto Service Management" \
  --job_type "run" \
  --inventory "WSL Lab" \
  --project "WSL Project" \
  --playbook "playbooks/service_management.yml" \
  --become_enabled "true" \
  --extra_vars '{"service_name": "cron", "service_state": "stopped", "debug_extra": false}'
```

## ðŸŽ¯ **Alternative: Check Current Project Status**

You can also verify what branch the project is currently configured to use:
# Update the project configuration to use CLPLAT-2230
```bash
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" \
  --scm_branch "CLPLAT-2230"

```

```bash
# Check current project configuration
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects get "$PROJECT_ID" | jq '{name, scm_branch, scm_revision}'
```

The key issue is that the branch change hasn't taken effect yet - the project updates are still pulling from `CLPLAT-2225` instead of `CLPLAT-2230`.
