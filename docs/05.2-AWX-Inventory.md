# AWX Inventory Management Script

This script automates AWX inventory, groups, and host management for WSL Lab instances.

## üìã **Configuration Parameters**

### **Environment Setup**
```bash
#!/bin/bash
# AWX Inventory Management Script
# Activate AWX virtual environment
source ~/awx-venv/bin/activate

# Extract stored OAuth2 token
export AWX_TOKEN=$(kubectl get secret awx-admin-password -n awx -o jsonpath='{.data.password}' | base64 -d)
```

### **Inventory Configuration**
```bash
# AWX Configuration Parameters
export INVENTORY_NAME="WSL Lab"
export GROUP_NAME="all_servers"
export ANSIBLE_USER="daniv"
export ANSIBLE_SSH_KEY="/home/daniv/.ssh/id_rsa"
export ANSIBLE_HOST_IP="172.22.192.129"

# Host Configuration Array
declare -A HOSTS
HOSTS[ubuntuAWX]="2225"
HOSTS[argo_cd_mgt]="2226"
HOSTS[wslkali1]="2224"
HOSTS[wslubuntu1]="2223"
```

### **Host List Reference**
| Host Name | IP Address | SSH Port | User | Groups |
|-----------|------------|----------|------|--------|
| ubuntuAWX | 172.22.192.129 | 2225 | daniv | all_servers |
| argo_cd_mgt | 172.22.192.129 | 2226 | daniv | all_servers |
| wslkali1 | 172.22.192.129 | 2224 | daniv | all_servers |
| wslubuntu1 | 172.22.192.129 | 2223 | daniv | all_servers |

## üîß **Script Functions**

### **Function 1: Create Inventory**
```bash
create_inventory() {
  echo "Creating inventory: $INVENTORY_NAME"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory create \
    --name "$INVENTORY_NAME" \
    --description "WSL instances for automation" \
    --organization Default
  
  # Get the inventory ID
  INVENTORY_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory list --name "$INVENTORY_NAME" --format json | jq -r '.results[0].id')
  echo "Inventory ID: $INVENTORY_ID"
}
```

### **Function 2: Create Group**
```bash
create_group() {
  echo "Creating group: $GROUP_NAME"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" group create \
    --name "$GROUP_NAME" \
    --inventory "$INVENTORY_ID"
}
```

### **Function 3: Add All Hosts**
```bash
add_hosts() {
  echo "Adding hosts to inventory..."
  for host_name in "${!HOSTS[@]}"; do
    port="${HOSTS[$host_name]}"
    echo "Adding host: $host_name ($ANSIBLE_HOST_IP:$port)"
    
    awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts create \
      --name "$host_name" \
      --inventory "$INVENTORY_ID" \
      --variables "{\"ansible_host\": \"$ANSIBLE_HOST_IP\", \"ansible_port\": $port, \"ansible_user\": \"$ANSIBLE_USER\", \"ansible_ssh_private_key_file\": \"$ANSIBLE_SSH_KEY\"}"
  done
}
```

### **Function 4: Add Hosts to Group**
```bash
add_hosts_to_group() {
  echo "Adding hosts to group: $GROUP_NAME"
  # Get group ID first
  GROUP_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list --inventory "$INVENTORY_ID" --name "$GROUP_NAME" | jq -r '.results[0].id')
  
  for host_name in "${!HOSTS[@]}"; do
    echo "Adding $host_name to group: $GROUP_NAME"
    # Get host ID first
    HOST_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --inventory "$INVENTORY_ID" --name "$host_name" | jq -r '.results[0].id')
    
    # Add host to group using the modify command
    awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups modify "$GROUP_ID" \
      --add_hosts "$HOST_ID"
  done
}
```

### **Function 5: Verify Configuration**
```bash
verify_configuration() {
  echo "=== Verification ==="
  
  echo "Hosts in Inventory:"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --inventory "$INVENTORY_ID" | jq '.results[] | {name, variables}'
  
  echo "Hosts in Group:"
  GROUP_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list --inventory "$INVENTORY_ID" --name "$GROUP_NAME" | jq -r '.results[0].id')
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups get "$GROUP_ID" | jq '.summary_fields.hosts.results[] | .name'
  
  echo "Groups in Inventory:"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list --inventory "$INVENTORY_ID" | jq '.results[] | {name, inventory_id: .inventory}'
}
```

## üöÄ **Main Script Execution**

### **Complete Setup Script**
```bash
main() {
  echo "Starting AWX Inventory Setup..."
  
  # Step 1: Create inventory
  create_inventory
  
  # Step 2: Create group
  create_group
  
  # Step 3: Add all hosts
  add_hosts
  
  # Step 4: Add hosts to group
  add_hosts_to_group
  
  # Step 5: Verify configuration
  verify_configuration
  
  echo "Setup complete!"
}

# Run the main function
main
```

## üßπ **Cleanup Functions**

### **Function 6: Remove Hosts from Group**
```bash
remove_hosts_from_group() {
  echo "Removing hosts from group: $GROUP_NAME"
  # Get group ID first
  GROUP_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false groups list --inventory "$INVENTORY_ID" --name "$GROUP_NAME" | jq -r '.results[0].id')
  
  for host_name in "${!HOSTS[@]}"; do
    echo "Removing $host_name from group: $GROUP_NAME"
    # Get host ID first
    HOST_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" -f json --conf.color false hosts list --inventory "$INVENTORY_ID" --name "$host_name" | jq -r '.results[0].id')
    
    # Remove host from group using the modify command
    awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups modify "$GROUP_ID" \
      --remove_hosts "$HOST_ID"
  done
}
```

### **Function 7: Delete All Hosts**
```bash
delete_all_hosts() {
  echo "Deleting all hosts (removes from ALL inventories)"
  for host_name in "${!HOSTS[@]}"; do
    echo "Deleting host: $host_name"
    awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" hosts delete "$host_name"
  done
}
```

### **Function 8: Delete Group**
```bash
delete_group() {
  echo "Deleting group: $GROUP_NAME"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" groups delete "$GROUP_NAME"
}
```

### **Function 9: Delete Inventory**
```bash
delete_inventory() {
  echo "Deleting inventory: $INVENTORY_NAME"
  awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory delete "$INVENTORY_ID"
  echo "Inventory deleted!"
}
```

### **Function 10: Complete Cleanup**
```bash
cleanup_all() {
  echo "Starting complete cleanup..."
  remove_hosts_from_group
  delete_all_hosts
  delete_group
  delete_inventory
  echo "Cleanup complete!"
}
```

## üìã **Usage Examples**

### **Setup Everything**
```bash
# Run the complete setup
main
```

### **Cleanup Everything**
```bash
# Remove everything
cleanup_all
```

### **Individual Operations**
```bash
# Just add hosts (if inventory and group already exist)
add_hosts
add_hosts_to_group

# Just verify current state
verify_configuration

# Just remove from group (keep hosts in inventory)
remove_hosts_from_group

# Just delete the inventory (keeps hosts but removes them from this inventory)
delete_inventory
```

## üìù **Complete Script File**

Save all the functions above into a single script file:

```bash
#!/bin/bash
# AWX Inventory Management Script
# Usage: ./awx-inventory-manager.sh

# [Include all configuration parameters and functions from above]

# Main execution
main
```
