
# AWX Inventory Management

This guide covers how to interact with your AWX "WSL Lab" inventory and extract host information.

## Prerequisites

Set up your AWX environment variables:
```bash
# Extract stored OAuth2 token
export AWX_TOKEN=$(kubectl get secret awx-admin-password -n awx -o jsonpath='{.data.password}' | base64 -d)
export inventory_name="WSL Lab"
```

## 1. Get Inventory Information

### Get Inventory ID
```bash
# Get the inventory ID for the "WSL Lab" inventory
Inventory_id=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" inventory list --name "$inventory_name" --format json | jq -r '.results[0].id')

echo "Inventory ID: $Inventory_id"
```

## 2. List Hosts in Inventory

### Quick Host Summary
```bash
# Get basic host information
host_json=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$inventory_name" --format json)

echo "=== Host Summary for '$inventory_name' ==="
echo "$host_json" | jq -r '.results[] | "Host: \(.name), Last Job: \(.last_job // "None")"'
```

### Detailed Host Information
```bash
# Get detailed host information with variables
echo "$host_json" | jq -r '.results[] | 
  "Host: " + .name + "\n" +
  "  Last Job: " + (.last_job | tostring) + "\n" +
  "  Variables: " + (.variables | tostring) + "\n"'
```

### Current WSL Lab Hosts
Based on your AWX inventory, you have these hosts:
- **argo_cd_mgt**: `172.22.192.129:2226`
- **ubuntuAWX**: `172.22.192.129:2225`
- **wslkali1**: `172.22.192.129:2224`
- **wslubuntu1**: `172.22.192.129:2223`

## 3. Export Inventory to YAML

### Simple Export (Basic Format)
```bash
# Export hosts to basic YAML format
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$inventory_name" --format json | \
jq -r '.results[] | "- name: \(.name)\n  ansible_host: \(.variables | fromjson | .ansible_host)\n  ansible_port: \(.variables | fromjson | .ansible_port)\n  ansible_user: daniv"' > inventory/wsl_instances_actual.yml
```

### Complete Ansible Inventory Export
```bash
# Generate complete Ansible inventory structure
cat > inventory/wsl_instances_actual.yml << 'EOF'
---
all:
  children:
    wsl_instances:
      hosts:
EOF

# Add each host with proper indentation and variables
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$inventory_name" --format json | \
jq -r '.results[] | "        \(.name):\n          ansible_host: \(.variables | fromjson | .ansible_host)\n          ansible_port: \(.variables | fromjson | .ansible_port)\n          ansible_user: daniv"' >> inventory/wsl_instances_actual.yml

# Add common variables and groups
cat >> inventory/wsl_instances_actual.yml << 'EOF'
      vars:
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_python_interpreter: /usr/bin/python3
        awx_user: daniv
        sudoers_type: "systemctl"
        
    service_test_hosts:
      hosts:
EOF

# Add all hosts to service_test_hosts group
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" host list --inventory "$inventory_name" --format json | \
jq -r '.results[] | "        \(.name):"' >> inventory/wsl_instances_actual.yml

# Add service test variables
cat >> inventory/wsl_instances_actual.yml << 'EOF'
      vars:
        service_mgmt_service_name: cron
        service_mgmt_service_state: stopped
EOF

echo "Inventory exported to inventory/wsl_instances_actual.yml"
```

## 4. Key Points

### WSL Instance Configuration
- **Same IP**: All WSL instances share `172.22.192.129`
- **Different Ports**: Each instance uses unique SSH ports (2223-2226)
- **Same User**: All instances use `daniv` as the SSH user



```bash



PROJECT_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project list | jq -r '.results[] | select(.name=="WSL Project") | .id')
echo "Project ID: $PROJECT_ID"


# Update the project to use CLPLAT-2230 branch
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" --scm_branch "CLPLAT-2230"

# Get the latest project update ID for your project
PROJECT_UPDATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates list --project "$PROJECT_ID" | jq -r '.results[0].id')
echo "Latest Project Update ID: $PROJECT_UPDATE_ID"


# Check the status of the latest project update
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates get "$PROJECT_UPDATE_ID"


awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" --scm_update_revision


# Create the job template (should work now with updated branch)
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" --scm_update_revision




# Delete the existing project
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects delete "$PROJECT_ID"

# Create a new one with the correct branch
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects create \
  --name "WSL Project" \
  --description "Playbooks for WSL Lab" \
  --organization "Default" \
  --scm_type "git" \
  --scm_url "https://github.com/cloud-plat-org/ansible-playbook-config-testing.git" \
  --scm_branch "CLPLAT-2230"
### project id: 13
# Update the PROJECT_ID to the new project
PROJECT_ID=13

# Check the sync status
PROJECT_UPDATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates list --project 13 | jq -r '.results[0].id')
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates get "$PROJECT_UPDATE_ID" | jq '{id, status}'
echo $PROJECT_UPDATE_ID

# Create the job template with the new project
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates create \
  --name "Auto Service Management" \
  --job_type "run" \
  --inventory "WSL Lab" \
  --project "WSL Project" \
  --playbook "playbooks/service_management.yml" \
  --become_enabled "true" \
  --extra_vars '{"service_name": "cron", "service_state": "stopped", "debug_extra": false}'


# Launch the job template
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates launch 14

```




##  **Updated AWX Job Template Creation Commands**

### **Step 1: Set up your AWX token**
```bash
export AWX_TOKEN=$(kubectl get secret awx-admin-password -n awx -o jsonpath='{.data.password}' | base64 -d)
```

### **Step 2: Get your existing project ID**
```bash
PROJECT_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project list | jq -r '.results[] | select(.name=="WSL Project") | .id')
echo "Project ID: $PROJECT_ID"
```

### **Step 3: Create the Job Template using your existing project**
```bash

# Create the job template using your existing WSL Project
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates create \
  --name "Auto Service Management" \
  --job_type "run" \
  --inventory "WSL Lab" \
  --project "WSL Project" \
  --playbook "playbooks/service_management.yml" \
  --become_enabled "true" \
  --extra_vars '{"service_name": "cron", "service_state": "stopped", "debug_extra": false}'

```

### **Step 4: Verify the job template was created**
```bash
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates list --name "Service Management - WSL Instances"
```

### **Step 5: (Optional) Create a Survey for better user experience**
```bash
# Get the job template ID first
JOB_TEMPLATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates list --name "Service Management - WSL Instances" | jq -r '.results[0].id')

# # Add survey
# awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates survey_spec \
#   --id "$JOB_TEMPLATE_ID" \
#   --spec '{
#     "name": "Service Management Survey",
#     "description": "Configure service management parameters",
#     "spec": [
#       {
#         "type": "text",
#         "question_name": "Service Name",
#         "variable": "service_name",
#         "default": "cron",
#         "question_description": "Name of the service to manage (e.g., cron, sshd, nginx)"
#       },
#       {
#         "type": "multiplechoice",
#         "question_name": "Service State",
#         "variable": "service_state",
#         "choices": ["started", "stopped", "restarted", "reloaded"],
#         "default": "started",
#         "question_description": "Desired state of the service"
#       },
#       {
#         "type": "multiplechoice",
#         "question_name": "Debug Output",
#         "variable": "debug_extra",
#         "choices": ["false", "true"],
#         "default": "false",
#         "question_description": "Show verbose debug output (false = clean, true = verbose)"
#       }
#     ]
#   }'
# ```

## ðŸ“‹ **Key Changes Made:**

- **Used existing project**: "WSL Project" instead of creating a new one
- **Repository**: Points to your existing `https://github.com/cloud-plat-org/ansible-playbook-config-testing.git`
- **Branch**: Will use your configured branch `CLPLAT-2225`
- **Auto-update**: Your project has `scm_update_on_launch: true`, so it will pull latest changes















The issue is that you need to update the project configuration first, then sync. Try this approach:

### **Step 1: Update the project configuration directly**
```bash
# Update the project to use CLPLAT-2230 branch
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" \
  --scm_branch "CLPLAT-2230" \
  --scm_update_on_launch true
```

### **Step 2: Wait for the update to complete, then check status**
```bash
# Wait a moment, then check the latest project update
PROJECT_UPDATE_ID=$(awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates list --project "$PROJECT_ID" | jq -r '.results[0].id')
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" project_updates get "$PROJECT_UPDATE_ID" | jq '{id, status, scm_branch}'
```

### **Step 3: Once the update shows "successful" status, try creating the job template**
```bash
# Create the job template
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" job_templates create \
  --name "Auto Service Management" \
  --job_type "run" \
  --inventory "WSL Lab" \
  --project "WSL Project" \
  --playbook "playbooks/service_management.yml" \
  --become_enabled "true" \
  --extra_vars '{"service_name": "cron", "service_state": "stopped", "debug_extra": false}'
```

## ðŸŽ¯ **Alternative: Check Current Project Status**

You can also verify what branch the project is currently configured to use:
# Update the project configuration to use CLPLAT-2230
```bash
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects update "$PROJECT_ID" \
  --scm_branch "CLPLAT-2230"

```

```bash
# Check current project configuration
awx --conf.host https://localhost -k --conf.token "$AWX_TOKEN" projects get "$PROJECT_ID" | jq '{name, scm_branch, scm_revision}'
```

The key issue is that the branch change hasn't taken effect yet - the project updates are still pulling from `CLPLAT-2225` instead of `CLPLAT-2230`.









